# Using colcon to build packages
* 목표: colcon을 이용하여 ros2 workspace를 만든다.

다음은 colcon을 사용하여 ROS 2 워크스페이스를 생성하고 구축하는 방법에 대한 간단한 튜토리얼이다. 이 튜토리얼은 실용적이며 핵심 문서를 대체하도록 설계되지 않았다.
## Background
colcon은 ros2에서 제공되는 공식 빌드 도구로 기존의 catkin_make, catkin_make_isolated, catkin_tools 과 ament_tools 등 여러 빌드 도구의 발전형이다. colcon의 디자인에 대한 정보를 알고 싶다면 https://design.ros2.org/articles/build_tool.html 의 문서를 확인하면 된다. 소스코드는 https://github.com/colcon에서 확인할 수 있다.       
package란?- 노드, 라이브러리, 런치 파일 및 다른 여러 정보,파일 등을 하나로 묶는 구조     
## Prerequisites
### Install colcon
```
$sudo apt install python3-colcon-common-extensions
```
해당명령어를 통해 colcon을 다운받는다. 만약 오류가 뜬다면 pip으로 colcon을 설치한다.   
```
$pip3 install -U colcon-common-extensions
```
## 1. Basics
ROS workspace는 특정 구조를 가지는 디렉토리이다. 일반적으로 src 하위디렉토리가 있다. 해당 하위디렉토리 안에는 ROS 패키지의 소스코드가 위치하게 된다. 일반적으로 디렉토리는 비어 있는 상태로 시작한다.  colcon은 out-of-source 빌드(소스코드 밖에서의 빌드)를 수행한다. 기본적으로 colcon은 src 디렉터리와 같은 위치에 다음과 같은 디렉터리들을 생성한다.       
* build 디렉터리는 빌드 과정에서 생성되는 중간 파일(임시파일)이 저장되는 곳이다. 각 패키지별로 하위 폴더가 만들어지고, CMake와 같은 빌드가 이 안에서 이루어진다.
* install 디렉터리는 빌드가 끝나고 나면, 각 패키지가 실제로 설치되는 공간이다. 기본적으로 패키지마다 별도의 설치 하위 폴더가 생긴다.
* log 디렉터리는 colcon 명령을 실행할 때의 다양한 log(실행기록, 에러정보 등)가 저장되는 폴더이다.

주의!- catkin(이전 ros빌드 툴)과 비교했을 때, colcon에는 별도의 devel 디렉터리가 없다. (이전 ROS에서 빌드 중간 결과와 런타임 환경 파일이 보관되는 공간이었으나, colcon에서는 install 방식으로 대체되어 더 효율적인 구조를 가진다.)
<img width="1536" height="1024" alt="generated-image" src="https://github.com/user-attachments/assets/ed282d93-feb1-4c62-ab5b-c85476d65e00" />

### Create a workspace
linux에서 코드가 작성되었다.      
먼저 workspace가 포함된 디렉토리인 ros2_ws를 만들어 준다.   

```
$mkdir -p ~/ros2_ws/src
$cd ~/ros2_ws
```
여기서 mkdir은 드라이브를 만드는 명령어이다. -p옵션은 중첩된 폴더 구조를 한 번에 만들고 싶을 때 쓰는 편리한 옵션이며 이 옵션이 없으면 상위 폴더가 없어서 오류가 난다. 이 시점에서 워크스페이스는 하나의 빈 디렉토리 src만 포함하고 있다.    
```
.
└── src

1 directory, 0 files
```
### Add some sources
src 디렉토리에 소스코드를 추가하기 위해 ROS 2 examples 공식 레포(https://github.com/ros2/examples)를 받아 줄것이다. 이는 다음의 명령어를 이용한다.    
```
$git clone https://github.com/ros2/examples src/examples -b humble
```
이제 워크스페이스는 ros2 examples의 소스코드를 갖고 있다.         
```
.
└── src
    └── examples
        ├── CONTRIBUTING.md
        ├── LICENSE
        ├── rclcpp
        ├── rclpy
        └── README.md

4 directories, 3 files
```

<img width="651" height="155" alt="image" src="https://github.com/user-attachments/assets/72535fb8-c1de-4518-ba70-ce5d685c60ad" />     

### Source an underlay
이미 설치된 ros2 환경의 설정을 source(적용)하는 것이 매우 중요하다. 이 기존 ros2 설치 환경은, 예제 패키지들의 빌드에 필요한 의존성들을 제공한다. 이 작업은 보통 바이너리 설치나 소스 설치(또는 다른 colcon 워크스페이스)가 제공하는 setup 스크립트를 source하는 방식으로 이루어진다. 우리는 이러한 기존 환경을 underlay(언더레이)라고 부른다.     
그리고 우리가 만든 워크스페이스인 ros2_ws는 기존의 ros2 설치 위에 덧붙여지는 overlay(오버레이)역할을 한다. 일반적으로, 많은 패키지를 한 워크스페이스에 모두 넣기보다는, 소수의 패키지를 집중적으로 개발/수정할 때는 오버레이 워크스페이스를 사용하는 것이 권장된다. 즉, 기존 ROS 2 설치(underlay)가 제공하는 환경 위에 내가 작업하는 워크스페이스(overlay)를 올려서 빌드와 실행을 한다는 의미이다. 요약하자면 underlay-> 이미 설치되어 있는 ros2 환경(혹은 기존 workspace),  overlay-> 내가 현재 작업 중인 새로운 workspace
### Build the workspace
* attention!-만약 windows에서 패키지를 빌드한다면 visual studio 환경이 필요하며, https://docs.ros.org/en/humble/Installation/Alternatives/Windows-Development-Setup.html#windows-dev-build-ros2 이를 참고한다.

워크스페이스의 루트 디렉터리에서 colcon build를 실행한다. ament_cmake와 같은 빌드 타입은 devel 공간이라는 개념을 지원하지 않으며, 패키지를 반드시 설치해야한다. 그래서 colcon은 --symlink-install 옵션을 지원한다. 이 옵션을 사용하면, 설치된 파일이 src(소스공간)의 파일과 심볼릭 링크로 연결되기 때문에 예를 들어 Python 파일처럼 컴파일이 필요 없는 리소스는소스 파일을 직접 수정하기만 해도 설치 파일이 즉시 바뀌어 적용된다. 이렇게 하면 반복적인 개발(빠른 수정/테스트)이 훨씬 더 빠르고 효율적으로 이루어진다.        
쉽게 말해 원래 "소스 코드를 바꿀 때마다 설치 과정을 반복"해야 변화가 적용된다. 하지만, --symlink-install 옵션을 쓰면, 코드를 고치는 즉시 그 변화가 곧바로 실행에 반영된다. 그렇기에 Python 같은 파일은 저장만 해도 바로 테스트/실행할 수 있어서 개발이 훨씬 빨라지게된다. 따라서 개발할 땐 옵션을 붙이고 배포하거나 다른 환경에 설치할 땐 옵션을 빼게 된다.       
```
$colcon build --symlink-install
```
error가 뜬다면, source /opt/ros/humble/setup.bash를 실행하고 명령어를 작성해준다.(언더레이를 적용하는 과정)     
팁!-CPU, 메모리(RAM), 입출력(I/O) 성능이 제한적인 시스템(예: Raspberry Pi)에서는
colcon build 명령어를 실행할 때 화면과 마우스가 멈추는 현상이 발생할 수 있다. 이럴 경우, 병렬로 빌드하는 대신 패키지를 하나씩 순차적으로 빌드하도록 하는 --executor sequential 옵션을 사용하는 것이 도움이 될 수 있다. 필요한 추가 옵션들은 colcon 공식 문서를 참고하라. https://colcon.readthedocs.io/en/released/reference/executor-arguments.html       
빌드가 끝난다면  build, install, log 디렉토리들을 확인할 수 있다.    
```
.
├── build
├── install
├── log
└── src

4 directories, 0 files
```
<img width="396" height="43" alt="image" src="https://github.com/user-attachments/assets/c0e42406-8378-4583-b84e-26b9bedb9874" />       

### Run tests
colcon을 이용해 빌드 후, 다음과 같은 명령어로 테스트 코드를 실행할 수 있다. 이를 통해 자신이 만든 프로그램이나 코드가 제대로 동작하는지 확인해본다.    
```
$colcon test
```
<img width="736" height="118" alt="image" src="https://github.com/user-attachments/assets/49d598d6-d1e0-45f2-a796-93c5a1c3beec" />       

### Source the environment
colcon이 빌드를 성공적으로 완료하면, 결과물이 install 디렉터리에 생성된다. 설치된 실행 파일이나 라이브러리를 사용하기 전에, 이들을 내 터미널의 경로(PATH)와 라이브러리 경로에 추가해야 한다. colcon은 install 디렉터리 안에, 환경 설정을 도와주는 bash 파일이나 bat 파일(윈도우용)을 자동으로 생성한다. 이 파일들을 실행(source)하면, 필요한 모든 경로들이 PATH와 라이브러리 경로에 추가되고, 패키지에서 export한 bash 또는 shell 명령들도 사용할 수 있게 된다.    
쉽게 말해, install경로에는 package를 build한 결과물 lib, share, 실행파일등이 담겨있다. 실행 파일 및 library를 사용하려면 이들을 path및 library path에 포함시켜야 한다.이렇게 포함 시키는 것을 작업환경을 source한다고 한다. 이렇게 source하기 위해서는 install폴더에 있는 setup.bash를 이용하면 된다. 이 setup.bash는 colcon으로 package를 build할 때 생성된다.     
```
$source install/setup.bash
```
### Try a demo
환경을 소스하면, colcon에서 구축한 실행파일을 실행할 수 잇따. 예제에서 subscriber 노드를 실행해보자.   
```
$ros2 run examples_rclcpp_minimal_subscriber subscriber_member_function
```
다른 터미널에서는 publisher 노드를 실행해보자(setup 스크립트를 소스하는것을 잊지 마라)
```
$ros2 run examples_rclcpp_minimal_subscriber subscriber_member_function
```
<img width="1014" height="642" alt="image" src="https://github.com/user-attachments/assets/17660906-d687-4f14-8938-e7c71ec73732" />       
다음과 같이 publisher node에서 message를 publish하고, subscriber node에서 해당 message를 subscribe하는 것을 다음 이미지와 같이 확인 할 수 있다.
 
## 2. Create your own package

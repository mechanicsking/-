# Understanading actions
* 목표: ros2에서 action을 알아본다.

## Background
action은 ros2에서 의사소통 타입중 하나이고 장기적인 작업을 위해 설계되었다. action은 goal, feedback, result 3가지의 파트로 이루어져있다. 액션은 토픽과 서비스로 이루어져있다. 이것의 기능은 서비스와 유사하지만 액션은 취소할 수 있다. 이것은 단일 응답을 반환하는 서비스와는 대조적으로 일정한 피드백을 제공한다.       
액션은 publisher-subscriber모델과 비슷한 client-server 모델을 사용한다. action client노드는 action server노드에게 목표를 보낸다. 서버는 목표를 받고 승인하며, 작업 진행 상황(feedback)을 계속 알려주고, 마지막에 최종 결과(recult)도 전달한다.     
<img width="854" height="480" alt="image" src="https://github.com/user-attachments/assets/bdf1fdbb-f937-48d2-a2db-4d0ad9ff17d6" />     
## Tasks
### 1. Setup
/turtlesim과 /teleop_turtle 노드를 실행하자.    
### 2. Use actions
/teleop_turtle 노드를 실행하면, 다음과 같은 메시지를 터미널에서 확인할 수 있다.    
```
Use arrow keys to move the turtle.
Use G|B|V|C|D|E|R|T keys to rotate to absolute orientations. 'F' to cancel a rotation.
```
action에 해당하는 두번째 줄을 보자(첫번째 지침은 이전의 토픽 튜토리얼에서 논의된 "cmd_vel"주제에 해당한다.)       
G|B|V|C|D|E|R|T 문자열은 키보드에서 F 키를 둘러싼 박스 모양이라는 것을 알 수 있다. F주변의 각키는 turtlesim의 해당 방향에 해당한다. 예를 들어 E 키는 turtle의 방향을 왼쪽 위코너를 향하게 한다.        
/turtlesim 노드가 작동중인 터미널을 집중하라. 이 키들을 누르는 각각의 시간에 /turtlesim 노드의 action server에 목표를 보내고 있다. 목표는 turtle의 얼굴이 특별한 방향으로 회전하는 것이다. 거북이가 회전을 완료하면 목표 결과를 전달하는 메시지가 다음과 같이 표현되어야한다. 

```
[INFO] [turtlesim]: Rotation goal completed successfully
```    
F키는 실행 중에 목표를 취소한다. C를 누르고 turtle이 회전을 완료하기 전에 F키를 눌러보면 /turtlesim 노드가 작동중인 터미널에서는 다음의 메시지를 볼 수 있다.    
```
[INFO] [turtlesim]: Rotation goal canceled
```
client-side(teleop에 입력한 값)에서 목표를 멈출수 있고, server-side(/turtlesim 노드)에서도 목표를 멈출 수 있다. server-side에서 목표를 멈추는 것을 'abort'(중단)한다고 한다.      
D키를 누르고 이 첫번째 회전이 완료되기 전에 G키를 누르면 /turtlesim노드가 작동되는 터미널에서 다음의 메시지를 볼 수 있다.    
```
[WARN] [turtlesim]: Rotation goal received before a previous goal finished. Aborting previous goal
```
이 액션 서버는 첫번째 목표를 abort하기를 선택했다. 그 이유는 새로운 목표를 얻었기 때문이다. 새로운 목표를 거부하거나 첫번째 목표가 끝난 후 두 번째 목표를 실행하는 등 다른 방법도 있다. 그렇기에 모든 액션 서버가 새로운 목표를 얻었을 대 현재 목표를 중단하기로 선택한다고 가정하면 안된다.     
### ros2 node info 
노드가 제공하는 action의 리스트를 확인해보자. /turtlesim의 경우, 새로운 터미널을 열어 다음의 커멘드를 실행해보자.    
```
$ros2 node info /turtlesim
/turtlesim
  Subscribers:
    /parameter_events: rcl_interfaces/msg/ParameterEvent
    /turtle1/cmd_vel: geometry_msgs/msg/Twist
  Publishers:
    /parameter_events: rcl_interfaces/msg/ParameterEvent
    /rosout: rcl_interfaces/msg/Log
    /turtle1/color_sensor: turtlesim/msg/Color
    /turtle1/pose: turtlesim/msg/Pose
  Service Servers:
    /clear: std_srvs/srv/Empty
    /kill: turtlesim/srv/Kill
    /reset: std_srvs/srv/Empty
    /spawn: turtlesim/srv/Spawn
    /turtle1/set_pen: turtlesim/srv/SetPen
    /turtle1/teleport_absolute: turtlesim/srv/TeleportAbsolute
    /turtle1/teleport_relative: turtlesim/srv/TeleportRelative
    /turtlesim/describe_parameters: rcl_interfaces/srv/DescribeParameters
    /turtlesim/get_parameter_types: rcl_interfaces/srv/GetParameterTypes
    /turtlesim/get_parameters: rcl_interfaces/srv/GetParameters
    /turtlesim/list_parameters: rcl_interfaces/srv/ListParameters
    /turtlesim/set_parameters: rcl_interfaces/srv/SetParameters
    /turtlesim/set_parameters_atomically: rcl_interfaces/srv/SetParametersAtomically
  Service Clients:

  Action Servers:
    /turtle1/rotate_absolute: turtlesim/action/RotateAbsolute
  Action Clients:
```
이 커멘드는 /turtlesim의 subscriber, publisher, service, action server, action client의 리스트를 반환한다.     
/turtlesim의 /turtle1/rotate_absolute 액션은 Action servers아래에 있다. 이 뜻은 /turtlesim이 /turtle1/rotate_absolute 엑션에 반응하고 피드백을 제공한다는 것을 의미한다. /teleop_turtle 노드는 Action Clients에서 /turtle1/rotate_absolute라는 이름을 가지고 있으며, 이는 해당 액션 이름에 대한 목표를 전송한다는 의미이다. 이를 확인하려면 다음을 실행한다.     
```
$ros2 node info /teleop_turtle
/teleop_turtle
  Subscribers:
    /parameter_events: rcl_interfaces/msg/ParameterEvent
  Publishers:
    /parameter_events: rcl_interfaces/msg/ParameterEvent
    /rosout: rcl_interfaces/msg/Log
    /turtle1/cmd_vel: geometry_msgs/msg/Twist
  Service Servers:
    /teleop_turtle/describe_parameters: rcl_interfaces/srv/DescribeParameters
    /teleop_turtle/get_parameter_types: rcl_interfaces/srv/GetParameterTypes
    /teleop_turtle/get_parameters: rcl_interfaces/srv/GetParameters
    /teleop_turtle/list_parameters: rcl_interfaces/srv/ListParameters
    /teleop_turtle/set_parameters: rcl_interfaces/srv/SetParameters
    /teleop_turtle/set_parameters_atomically: rcl_interfaces/srv/SetParametersAtomically
  Service Clients:

  Action Servers:

  Action Clients:
    /turtle1/rotate_absolute: turtlesim/action/RotateAbsolute
```
### 4. ros2 action list
ros graph에서 모든 action을 확인하고 싶다면 다음의 커멘드를 실행한다.    
```
$ros2 action list
/turtle1/rotate_absolute
```
이것이 현재 ros graph에 있는 유일한 action이다. 이것은 앞에서 보았다시피 turtle의 회전을 조절한다. 
ros2 node info <node_name> 커멘드를 통해 한개의 action client(/teleop_turtle과 같은)와 한개의 action server(/turtlesim과 같은)가 있다는 것도 이미 알수 있었다.       
#### 4.1. ros2 action list -t
토픽, 서비스와 마찬가지로 action은 타입을 갖고 있다. 다음의 커멘드를 통해 /turtle1/rotate_absolute의 타입을 찾아보자.     
```
$ros2 action list -t
/turtle1/rotate_absolute [turtlesim/action/RotateAbsolute]
```
각 action의 이름 오른쪽 괄호 안에는(이 경우 /turtle1/rotate_absolute만) action type인 turtlesim/action/RotateAbsolute이 표시된다. 이 action type은 명령줄이나 코드에서 액션을 실제로 실행할 때 반드시 필요하다. 
### 5. ros2 action info
다음의 커멘드를 통해 /turtle1/rotate_absolute액션에 대해 더 자세히 알아보자.   
```
$ros2 action info /turtle1/rotate_absolute
Action: /turtle1/rotate_absolute
Action clients: 1
    /teleop_turtle
Action servers: 1
    /turtlesim
```
ros2 node info에서 각 노드를 알아보았을 때 배웠던것 같이,/turtle1/rotate_absolute액션에 대해 /teleop_turtle 노드는 action client를 갖고 있고, /turtlesim 노드는 action server를 갖고 있다.     
### 6. ros2 interface show
action 목표를 직접 보내거나 실행하기 전에 필요한 또 다른 정보는 action type의 구조이다. /turtle1/rotate_absolute이 타입은 ros2 action list -t 커멘드를 통해 알 수 있다는 것을 기억하라. 다음의 커멘드를 입력하면 터미널에서 액션의 타입을 알 수 있다.    
```
$ros2 interface show turtlesim/action/RotateAbsolute
```
이 명령어는 다음을 반환한다.   
```
# The desired heading in radians
float32 theta
---
# The angular displacement in radians to the starting position
float32 delta
---
# The remaining rotation in radians
float32 remaining
```
메시지를 나누는 첫번째 --- 위의 섹션은 목표 요청의 구조(데이터 유형 및 이름)이다. 다음 섹션은 결과의 구조이고 마지막 섹션은 피드백의 구조이다.     
### 7. ros2 action send_goal
이제 명령줄에서 다음 문법을 맞추어 action goal을 보내보자.    
```
$ros2 action send_goal <action_name> <action_type> <values>
```
<values>는 YAML 포멧일 필요가 있다.    
다음의 커멘드를 작성하고 turtlesim 윈도우를 확인하라. 
```
$ros2 action send_goal /turtle1/rotate_absolute turtlesim/action/RotateAbsolute "{theta: 1.57}"
Waiting for an action server to become available...
Sending goal:
   theta: 1.57

Goal accepted with ID: f8db8f44410849eaa93d3feb747dd444

Result:
  delta: -1.568000316619873

Goal finished with status: SUCCEEDED
```
turtle이 회전하는 모습을 볼 수 있다. 모든 goal은 고유한 ID를 가지고 있고, 반환되는 메시지에서 확인할 수 있다. recult를 볼 수 있는데 delta라는 이름을 가진 필드는 시작 위치로의 변위이다. 이 목표의 피드백을 보고 싶다면, ros2 action send_goal커멘드에 --feedbacak을 추가하면된다.     
```
$ros2 action send_goal /turtle1/rotate_absolute turtlesim/action/RotateAbsolute "{theta: -1.57}" --feedback
Sending goal:
   theta: -1.57

Goal accepted with ID: e6092c831f994afda92f0086f220da27

Feedback:
  remaining: -3.1268222332000732

Feedback:
  remaining: -3.1108222007751465

…

Result:
  delta: 3.1200008392333984

Goal finished with status: SUCCEEDED
```
목표에 달성할 때까지 남은 라디안에 대한 feedback을 받을 수 있다.         
<img width="474" height="996" alt="image" src="https://github.com/user-attachments/assets/df906706-2193-4de5-9d3b-746ff29733ff" />      

## Summary
action은 서비스와 비슷하지만 오래 걸리는 작업을 수행할 수 있고 정기적인 피드백을 제공하며 중간에 취소 할 수 있다는 특징이 있다. 로봇 시스템에서는 주로 네비게이션(이동)에 엑션을 사용한다. 액션의 목표는 로봇이 특정 위치까지 이동하라는 명령이 될 수 있다. 로봇이 그 위치까지 이동하는 동안, 진행사항(예: 이동 거리, 방향, 예상 도착 시간 등)을 피드백 메시지로 계속 전달 할 수 있고, 목적지에 도착하면 최종 결과메시지를 보낸다. turtlesim에는 action client가 turtle을 회전하는 목표를 보낼 때 이 목표를 받을 수 있는 action server가 있다. 이번 튜토리얼에선 /turtle1/rotate_absolute라는 액션을 살펴보았고 액션이 무엇인지, 어떻게 동작하는지 알 수 있었다. 

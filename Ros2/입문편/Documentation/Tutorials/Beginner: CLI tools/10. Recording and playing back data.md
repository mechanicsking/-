# Recording and playing back data
* 목표: 토픽에 대해 published된 데이터를 기록하여 언제든지 재생하고 검토할 수 있다.

## Background
ros2 bag는 시스템 안에서 publish된 데이터를 저장하기 위한 명령줄 도구이다. 여러 토픽에 전달된 데이터를 축적하여 데이터베이스에 저장한다. 그런 다음 데이터를 재생하여 테스트 및 실험 결과를 재현할 수 있다. 토픽을 기록하는 것도 work를 공유하고 다른 사람이 다시 만들 수 있도록 하는 좋은 방법이다. 테스트/실험 데이터를 기록하여 추후 재현 또는 공유할 수 있고 로봇 시스템의 동작 로그를 남겨 성능 분석에 유용하다. 
## Tasks
### 1. Setup
turtlesim 시스템에서 저장하고 나중에 재생하기 위해 키보드 인풋을 기록할 것이다. 따라서 /turtlesim 노드와 /teleop_turtle 노드를 실행시킨다.    
그 후 데이터 저장용 디렉토리를 생성한다. (리눅스 기준)
```
$mkdir bag_files
$cd bag_files
```
### 2. Choose a topic
ros2 bag는 토픽에서 published 메시지의 데이터만 기록할 수 있다. 시스템의 토픽 리스트를 보기 위해선 새로운 터미널을 열어 다음의 커멘드를 작성한다.    
```
$ros2 topic list
/parameter_events
/rosout
/turtle1/cmd_vel
/turtle1/color_sensor
/turtle1/pose
```
토픽 튜토리얼에서 /turtle_teleop 노드가 /turtle1/cmd_vel 토픽에 publishes commands를 보내 turtle을 움직이게 한다는 것을 배웠었다. /turtle1/cmd_vel이 게시하는 데이터를 보려면 다음의 명령어를 실행한다. (echo:  특정 토픽에서 발행(publish)되는 메시지를 실시간으로 터미널에 출력해주는 명령어)
```
$ros2 topic echo /turtle1/cmd_vel
```
처음에는 teleop에 의해 publishedㅚ는 데이터가 없기 때문에 아무것도 뜨지 않는다. teleop가 작동중인 터미널을 클릭하여 작동하게 만들어준후 arrow key를 눌러 turtle를 이동시킨다면 ros2 topic echo를 실행한 화면을 확인해보면 다음과 같이 publish된 데이터를 볼 수 있다.         
<img width="1237" height="544" alt="image" src="https://github.com/user-attachments/assets/bf626f7d-fc07-4378-a5a5-d966d2671b5c" />       

### 3. ros2 bag record
#### 3.1. Record a single topic
토픽으로 부터 published된 데이터를 기록하기 위해선 다음의 커멘드 문법을 사용한다.   
```
$ros2 bag record <topic_name>
```
선택한 토픽에 대해 이 커멘드를 작동하기 전에, 새로운 터미널을 열어 아까 만들어둔 bag_files 위치로 이동해준다. rosbag 파일을 이 위치로 저장할 것이기 때문이다.        
그 후 다음의 커멘드를 통해 저장을 시작해준다.    
```
$ros2 bag record /turtle1/cmd_vel
[INFO] [rosbag2_storage]: Opened database 'rosbag2_2019_10_11-05_18_45'.
[INFO] [rosbag2_transport]: Listening for topics...
[INFO] [rosbag2_transport]: Subscribed to topic '/turtle1/cmd_vel'
[INFO] [rosbag2_transport]: All requested topics are subscribed. Stopping discovery...
```

<img width="925" height="199" alt="image" src="https://github.com/user-attachments/assets/550f0810-a955-4faf-bc79-62d44e06ad44" />      

이제 ros2 bag는 /turtle1/cmd_vel 토픽에서 published되는 데이터를 기록중이다. teleop 터미널로 돌아와 turtle을 주위로 움직여본다. 움직임은 중요하지 않지만 나중에 데이터를 재생할 때 알아볼 수 있는 패턴으로 만든다.     
<img width="508" height="535" alt="image" src="https://github.com/user-attachments/assets/bcf5d986-0e7f-4dc1-8559-0331a06f9a82" />      


이후 ctrl+c를 통해 기록하는 것을 멈춘다.        
데이터는 rosbag2_year_month_day-hour_minute_second 형식의 이름으로 새로운 디렉토리에 저장된다. 이 디렉토리 안에는 녹화 파일에 대한 메타정보가 담긴 파일인 metadata.yaml과 실제 데이터(bag 파일)가 저장된다.   
#### 3.2. Record multiple topics
복수 토픽을 기록할 수 있을 뿐만 아니라 ros2 bag 저장 파일의 이름도 변경할 수 있다. 다음의 커멘드를 사용하자. 
```
$ros2 bag record -o subset /turtle1/cmd_vel /turtle1/pose
[INFO] [rosbag2_storage]: Opened database 'subset'.
[INFO] [rosbag2_transport]: Listening for topics...
[INFO] [rosbag2_transport]: Subscribed to topic '/turtle1/cmd_vel'
[INFO] [rosbag2_transport]: Subscribed to topic '/turtle1/pose'
[INFO] [rosbag2_transport]: All requested topics are subscribed. Stopping discovery...
```
-o 옵션을 사용하면 bag 파일의 고유한 이름을 선택할 수 있다. 이 명령어의 경우 string인  subset이 파일의 이름이다. 그리고 한번에 두 개 이상의 토픽을 기록하려면 각 토픽을 공백으로 구분하여 나열하기만 하면 되낟. 위 명령어의 경우 두개의 토픽이 모두 기록되고 있음을 확인할 수 있다. (/turtle1/cmd_vel /turtle1/pose)          
이후 turtle을 움직이고 ctrl+c를 눌러 마무리한다.       
<img width="508" height="535" alt="image" src="https://github.com/user-attachments/assets/042f59fb-052b-4e92-82dc-2b37afc5a3fe" />      
   

주의!-다른 옵션인 '-a' 커멘드를 추가하면 시스템의 모든 토픽을 기록한다. 
### 4. ros2 bag info
다음의 명령어 구조를 통해 기록된 것의 디테일을 볼 수 있다.  
```
$ros2 bag info <bag_file_name>
```
이명령어를 subset bag 파일에서 실행하면 파일에 대한 정보 목록이 반환된다.      
<img width="477" height="336" alt="image" src="https://github.com/user-attachments/assets/ec6a6cbd-2dab-4eed-bb13-038c9a57ce78" />       
     
### 5. ros2 bag play
bag file을 리플레이하기 전에 teleop가 작동중인 터미널을 ctrl+c를 통해 멈춰준다. 그리고 turtlesim 윈도우가 보이게 한다음 bag file을 재생한다. 다음의 커멘드를 작성한다.    
```
$ros2 bag play subset
[INFO] [rosbag2_storage]: Opened database 'subset'.
```
<img width="499" height="539" alt="image" src="https://github.com/user-attachments/assets/fd45a11a-e420-43ef-b25d-da3e336968a6" />      

이후에 저장한거와 마찬가지로 움직이는 것을 확인 할 수 있다. 아까 자동이름으로 저장한 기록도 재생해본다. ls를 통해 해당 파일의 이름을 확인한 후 실행해준다.     
```
$ros2 bag play rosbag2_2025_08_20-00_26_42
[INFO] [rosbag2_storage]: Opened database 'rosbag2_2025_08_20-00_26_42'.
```
<img width="499" height="539" alt="image" src="https://github.com/user-attachments/assets/e17fec8b-7738-4731-b731-49e6a82aacb8" />      

잘 작동하는 모습을 확인할 수 있다. turtle은 기록하는 동안 입력한 경로와 동일한 경로를 따를 것이다.(100%는 아니지만, 시스템 타이밍의 작은 변화에 민감하다.)     
subset 파일에 /turtle1/pose 토픽을 기록했기 때문에 ros2 bag play 명령을 실행하면 turtlesim 노드가 켜져있는 한 명령이 자동으로 종료되지 않는다. 그이유는 /turtlesim 노드가 활성화된 상태에서 /turtle1/pose 토픽에 대해 주기적으로 위치 정보 데이터를 publishe하기 때문이다. 예를들어, ros2 bag info에서 확인해볼 수 있는 /turtle1/cmd_vel 토픽의 메시지 개수(Count)는 11개이며, 이는 키보드 방향키를 눌러 거북이 이동을 제어한 횟수이다. 반면 /turtle1/pose 토픽의 메시지 개수는 3000개 이상으로, 이는 녹화하는 동안 위치 데이터가 매우 빈번하게(초당 수십 회 이상) 발행되었음을 나타낸다. /turtle1/pose 데이터가 얼마나 자주 발행되는지 확인하려면 아래 명령어를 실행할 수 있다.    
```
$ros2 topic hz /turtle1/pose
```
<img width="471" height="345" alt="image" src="https://github.com/user-attachments/assets/92f0807c-9dfd-45ce-b7e2-a1df2efe5f97" />     

## Summary
ros2 시스템에서 ros2 bag 커멘드를 사용하여 토픽에 전달된 데이터를 기록할 수 있다. 다른사람과 작업을 공유하든, 자신의 작업을 자세히 살펴보든 이는 휼륭한 도구이다. 

